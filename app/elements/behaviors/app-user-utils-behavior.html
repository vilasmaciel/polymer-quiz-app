<script>
var QuizApp = QuizApp || {};

QuizApp.AppUserUtilsBehavior = {

  properties: {
    user: {
      type: Object,
      notify: true
    },
    quizStatus: {
      type: String,
      notify: true
    }
  },

  _initializeProperties: function() {
    if (!this.user) {
      return console.error('No user found');
    }

    this.user.activities = this.user.activities || {};
    this.user.activities[this._getQuizId()] = this.user.activities[this._getQuizId()] || {};
    this.user.activities[this._getQuizId()].attempts = this.user.activities[this._getQuizId()].attempts || [];
  },

  userInitializeQuiz: function() {
    this._initializeProperties();

    this.user.activities[this._getQuizId()].attempts.unshift({
      attemptId: this._generateUUID()
    });

    this.user.activities[this._getQuizId()].attempts[0].status = 'initialized';

    this.fire('iron-signal', {
      name: 'user-changed',
      data: this.user
    });
  },

  userPauseQuiz: function() {
    this._initializeProperties();

    if (this.user.activities[this._getQuizId()]) {

      this.user.activities[this._getQuizId()].attempts[0].status = 'paused';

      this.fire('iron-signal', {
        name: 'user-changed',
        data: this.user
      });
    } else {
      console.error('Error on paused quiz. No previous data found');
    }
  },

  userResumeQuiz: function() {
    this._initializeProperties();

    if (this.user.activities[this._getQuizId()]) {

      this.user.activities[this._getQuizId()].attempts[0].status = 'resumed';

      this.fire('iron-signal', {
        name: 'user-changed',
        data: this.user
      });
    } else {
      console.error('Error on paused quiz. No previous data found');
    }
  },

  userInteractQuestion: function(value, index) {
    this._initializeProperties();

    this.user.activities[this._getQuizId()].attempts[0][this._getQuestionId()] = this.user.activities[this._getQuizId()][this._getQuestionId()] || {};

    this.user.activities[this._getQuizId()].attempts[0][this._getQuestionId()].selectedValue = value;
    this.user.activities[this._getQuizId()].attempts[0][this._getQuestionId()].selectedIndex = index;

    this.fire('iron-signal', {
      name: 'user-changed',
      data: this.user
    });
  },

  // getAttemptId: function() {

  // },

  getQuizStatus: function() {
    if (this.user &&
      this.user.activities &&
      this.user.activities[this._getQuizId()] &&
      this.user.activities[this._getQuizId()].attempts.length) {
      return this.user.activities[this._getQuizId()].attempts[0].status;
    }
  },

  getSelectedOption: function() {
    if (this.user &&
      this.user.activities &&
      this.user.activities[this._getQuizId()]) {

      if (this.user.activities[this._getQuizId()].attempts[0][this._getQuestionId()]) {
        return this.user.activities[this._getQuizId()].attempts[0][this._getQuestionId()].selectedValue;
      } else {
        return null;
      }
    }
  },

  _getQuizId: function() {
    if (!this.quiz) {
      console.error('quiz not found');
      return null;
    } else {
      var id = this.quiz.activityId.split('.').join('__');
      return id.split('/').join('__');
    }
  },

  _getQuestionId: function() {
    var id = this.question.activityId.split('.').join('__');
    return id.split('/').join('__');
  },

  _generateUUID: function() {
    /* jshint ignore:start */
    var d = new Date().getTime();
    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      var r = (d + Math.random() * 16) % 16 | 0;
      d = Math.floor(d / 16);
      return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });
    return uuid;
    /* jshint ignore:end */
  }

};
</script>
