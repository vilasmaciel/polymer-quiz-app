<link rel="import" href="app-quiz-utils-behavior.html">
<script>
var QuizApp = QuizApp || {};

var AppUserUtilsBehaviorImpl = {

  properties: {
    user: {
      type: Object,
      notify: true,
      observer: '_userChanged'
    },
    quizStatus: {
      type: String,
      notify: true
    }
  },

  _userChanged: function() {
    if (this.userChanged) {
      this.userChanged();
    }
  },

  _initializeProperties: function() {
    if (!this.user) {
      return console.error('No user found');
    }

    this.user.activities = this.user.activities || {};
    this.user.activities[this.getQuizId()] = this.user.activities[this.getQuizId()] || {};
    this.user.activities[this.getQuizId()].attempts = this.user.activities[this.getQuizId()].attempts || [];
  },

  userInitializeQuiz: function() {
    this._initializeProperties();

    this.user.activities[this.getQuizId()].attempts.unshift({
      attemptId: this._generateUUID()
    });

    this.user.activities[this.getQuizId()].attempts[0].status = 'initialized';

    this.fire('iron-signal', {
      name: 'user-changed',
      data: this.user
    });
  },

  userPauseQuiz: function() {
    this._initializeProperties();

    if (this.user.activities[this.getQuizId()]) {

      this.user.activities[this.getQuizId()].attempts[0].status = 'paused';

      this.fire('iron-signal', {
        name: 'user-changed',
        data: this.user
      });
    } else {
      console.error('Error on paused quiz. No previous data found');
    }
  },

  userResumeQuiz: function() {
    this._initializeProperties();

    if (this.user.activities[this.getQuizId()]) {

      this.user.activities[this.getQuizId()].attempts[0].status = 'resumed';

      this.fire('iron-signal', {
        name: 'user-changed',
        data: this.user
      });
    } else {
      console.error('Error on paused quiz. No previous data found');
    }
  },

  userTerminateQuiz: function() {
    this._initializeProperties();

    if (this.user.activities[this.getQuizId()]) {

      this.user.activities[this.getQuizId()].attempts[0].status = 'terminated';

      this.fire('iron-signal', {
        name: 'user-changed',
        data: this.user
      });
    } else {
      console.error('Error on paused quiz. No previous data found');
    }
  },

  userInteractQuestion: function(value, index) {
    this._initializeProperties();

    this.user.activities[this.getQuizId()].attempts[0][this.getQuestionId()] = this.user.activities[this.getQuizId()][this.getQuestionId()] || {};

    this.user.activities[this.getQuizId()].attempts[0][this.getQuestionId()].selectedValue = value;
    this.user.activities[this.getQuizId()].attempts[0][this.getQuestionId()].selectedIndex = index;

    this.fire('iron-signal', {
      name: 'user-changed',
      data: this.user
    });
  },

  _generateUUID: function() {
    /* jshint ignore:start */
    var d = new Date().getTime();
    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      var r = (d + Math.random() * 16) % 16 | 0;
      d = Math.floor(d / 16);
      return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });
    return uuid;
    /* jshint ignore:end */
  }

};

QuizApp.AppUserUtilsBehavior = [QuizApp.AppQuizUtilsBehavior, AppUserUtilsBehaviorImpl];
</script>
