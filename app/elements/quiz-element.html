<dom-module id="quiz-element">
  <template>
    <style is="custom-style" include="app-themes"></style>
    <style>
    :host {
      overflow-x: hidden;
    }

    #placeholder {
      height: 100%;
      width: 100%;
      background-color: var(--paper-grey-300);
    }

    paper-toolbar {
      background-color: transparent;
    }

    @media (max-width: 600px) {
      paper-toolbar {
        display: none;
      }
    }
    </style>
    <iron-media-query query="(max-width: 600px)" query-matches="{{wide}}"></iron-media-query>

    <div id="placeholder" class$="[[_concatClass('layout horizontal fit', quiz.theme)]]"></div>
    <div class="layout vertical fit">
      <paper-toolbar>
        <paper-icon-button on-tap="_pause" icon="arrow-back" hidden$="[[inResultsView]]"></paper-icon-button>
      </paper-toolbar>

      <neon-animated-pages id="quizPageSelector" selected="{{selected}}" class="flex">
        <quiz-front-page id="frontPage" quiz="{{quiz}}" wide="[[wide]]" on-quiz-start="_initialize" on-close-quiz-view="_close"></quiz-front-page>
        <question-list quiz="{{quiz}}" wide="[[wide]]" on-quiz-terminated="_terminate" on-quiz-paused="_pause"></question-list>
        <quiz-results-page quiz="{{quiz}}" wide="[[wide]]" on-close-quiz-view="_close"></quiz-results-page>
      </neon-animated-pages>
    </div>
  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'quiz-element',

      behaviors: [
        Polymer.NeonSharedElementAnimatableBehavior,
        Polymer.NeonAnimationRunnerBehavior
      ],

      properties: {
        quiz: {
          type: Object,
          notify: true,
          observer: '_quizChanged'
        },
        inResultsView: {
          type: Boolean,
          default: false
        },
        selected: {
          type: Number,
          notify: true,
          observer: '_selectedChanged'
        },

        animationConfig: {
          type: Object,
          value: function() {
            return {
              'entry': [{
                name: 'ripple-animation',
                id: 'ripple',
                toPage: this
              }],
              'exit': [{
                name: 'fade-out-animation',
                node: this.$.placeholder
              }, {
                name: 'transform-animation',
                transformFrom: 'none',
                transformTo: 'translate(0px,-200vh) scale(0.9,1)',
                node: this.$$('paper-toolbar')
              }]
            };
          }
        },

        sharedElements: {
          type: Object,
          value: function() {
            return {
              'ripple': this.$.placeholder
            };
          }
        }
      },

      _quizChanged: function() {
        if (this.quiz) {
          this.selected = 0;
          this.$.frontPage.show();
        }
      },

      _initialize: function() {
        this.fire('iron-signal', {
          name: 'initialized',
          data: {
            activity: this.quiz,
            parent: this.quiz.parent
          }
        });
        this._next();
      },

      _terminate: function() {
        this.fire('iron-signal', {
          name: 'terminated',
          data: {
            activity: this.quiz,
            parent: this.quiz.parent
          }
        });
        this._next();
      },

      _pause: function() {
        if (this.selected === 1) {
          this.$.quizPageSelector.selectedItem.pause();
          this.fire('iron-signal', {
            name: 'paused',
            data: {
              activity: this.quiz,
              parent: this.quiz.parent
            }
          });
        }
        this._close();
      },

      _close: function() {
        if (this.$.quizPageSelector.selectedItem.exit()) {
          this.fire('close');
          var _this = this;
          setTimeout(function() {
            _this.selected = 0;
            _this.quiz = undefined;
          }, 200);
        }
      },

      _next: function() {
        this.$.quizPageSelector.selectNext();
        if (this.selected === 1) {
          this.$.quizPageSelector.selectedItem.show();
        }
      },

      _getCategoryIcon: function(name) {
        return 'category-icons:' + name;
      },

      _concatClass: function(classess, newClass) {
        return classess + ' ' + newClass;
      },

      _selectedChanged: function() {
        this.inResultsView = (this.selected === 2);
      }

    });
  })();
  </script>
</dom-module>
